name: Publish package to GitHub Packages

on:
    push:
        branches:
            - master
jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  registry-url: 'https://npm.pkg.github.com'
                  scope: '@ltz-labs'
            - run: npm ci
            - name: Configure Git
              run: |
                  git config --global user.email "operacao@ltzcapital.com.br"
                  git config --global user.name "LTZ-CAPITAL"

            - name: Determine next version
              id: version
              run: |
                  current_version=$(node -pe "require('./package.json').version")
                  semver_parts=($(echo "$current_version" | tr '.' ' '))
                  major=${semver_parts[0]}
                  minor=${semver_parts[1]}
                  patch=${semver_parts[2]}

                  if [[ "$patch" == "9" ]]; then
                    next_version="$major.$(($minor + 1)).0"
                  elif [[ "$minor" == "9" ]]; then
                    next_version="$(($major + 1)).0.0"
                  else
                    next_version=$(npm version patch)
                  fi
                  echo "::set-output name=next_version::$next_version"

            - name: Update package.json
              run: |
                  npm version ${{ steps.version.outputs.next_version }}
            - run: npm publish
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.GH_TOKEN }}
